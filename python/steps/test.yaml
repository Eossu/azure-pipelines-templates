parameters:
  - name: PythonVersion
    type: string

steps:
  - template: provision.yaml
    parameters:
      PythonVersion: ${{ parameters.PythonVersion }}
  
  - template: install.yaml

  - script: |
      poetry run pytest -rxXs --junitxml=junit/test-results.xml --cov src --cov tests --cov-report xml --cov-report html
    displayName: "Test with pytest"
    env:
      POETRY_CACHE_DIR: $(Pipeline.Workspace)/.cache/pypoetry/
  
  - task: PublishTestResults@2
    displayName: "Publish test results"
    condition: succeededOrFailed()
    inputs:
      testResultsFiles: '**/test-*.xml'
      testRunTitle: 'Publish test results for Python $(python.version)'
  
  - task: PublishCodeCoverageResults@1
    displayName: "Publish code coverage"
    condition: succeededOrFailed()
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/**/coverage.xml'
      reportDirectory: '$(System.DefaultWorkingDirectory)/**/htmlcov'
